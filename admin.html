<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Demat Shield – Admin</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link rel="stylesheet" href="styles.css" />
  <style>
    body {
      margin: 0;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      background: #050816;
      color: #f9fafb;
      min-height: 100vh;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    .card {
      background: #111827;
      padding: 24px 28px;
      border-radius: 12px;
      box-shadow: 0 18px 40px rgba(0, 0, 0, 0.45);
      width: 100%;
      max-width: 420px;
    }
    h1 {
      font-size: 20px;
      margin: 0 0 4px;
    }
    p {
      margin: 0 0 18px;
      font-size: 14px;
      color: #9ca3af;
    }
    .input-label {
      font-size: 12px;
      margin-bottom: 4px;
      color: #9ca3af;
    }
    .input {
      width: 100%;
      border-radius: 8px;
      border: 1px solid #1f2937;
      background: #020617;
      color: #f9fafb;
      padding: 10px 12px;
      font-size: 14px;
      box-sizing: border-box;
    }
    .btn {
      width: 100%;
      margin-top: 14px;
      padding: 10px 12px;
      border-radius: 8px;
      border: none;
      font-size: 14px;
      cursor: pointer;
      background: #2563eb;
      color: #f9fafb;
    }
    .btn:disabled {
      opacity: 0.6;
      cursor: default;
    }
    .status {
      margin-top: 10px;
      font-size: 13px;
    }
    .status.ok { color: #4ade80; }
    .status.err { color: #f97373; }

    /* Dashboard */
    .dashboard-wrapper {
      max-width: 1100px;
      width: 100%;
    }
    .dash-card {
      background: #111827;
      padding: 20px 22px;
      border-radius: 12px;
      box-shadow: 0 18px 40px rgba(0, 0, 0, 0.45);
    }
    .top-row {
      display: flex;
      justify-content: space-between;
      gap: 12px;
      align-items: center;
      margin-bottom: 10px;
    }
    .pill {
      font-size: 12px;
      padding: 4px 8px;
      border-radius: 999px;
      background: #1e293b;
      color: #e5e7eb;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 12px;
      font-size: 13px;
    }
    th, td {
      padding: 8px 6px;
      border-bottom: 1px solid #1f2937;
      vertical-align: top;
    }
    th {
      text-align: left;
      font-weight: 500;
      color: #9ca3af;
      white-space: nowrap;
    }
    tr:nth-child(even) td {
      background: #020617;
    }
    .badge {
      font-size: 11px;
      padding: 2px 6px;
      border-radius: 999px;
      background: #1f2937;
    }
    .logout-btn {
      margin-top: 14px;
      background: #ef4444;
      width: auto;
      padding: 8px 14px;
    }
    select.status-select {
      background: #020617;
      color: #f9fafb;
      border-radius: 6px;
      border: 1px solid #1f2937;
      padding: 4px 6px;
      font-size: 12px;
    }
    .small {
      font-size: 12px;
      color: #9ca3af;
    }
    @media (max-width: 768px) {
      body {
        align-items: flex-start;
        padding: 16px 8px;
      }
      .dashboard-wrapper {
        max-width: 100%;
      }
      .dash-card {
        padding: 16px 10px;
      }
      table {
        font-size: 12px;
      }
    }
  </style>

  <script src="https://unpkg.com/@supabase/supabase-js@2.48.0/dist/umd/supabase.js"></script>
</head>
<body>
  <!-- LOGIN CARD -->
  <div class="card" id="login-card">
    <h1>Admin Login</h1>
    <p>No password. Click the button and we’ll email a one-time login link.</p>

    <div class="input-label">Admin email</div>
    <input
      id="admin-email"
      class="input"
      type="email"
      value="dematshield@outlook.in"
      disabled
    />

    <button class="btn" id="send-link-btn">Send login link</button>
    <div class="status" id="status-msg"></div>
  </div>

  <!-- DASHBOARD -->
  <div class="dashboard-wrapper" id="dashboard-wrapper" style="display:none;">
    <div class="dash-card">
      <div class="top-row">
        <div>
          <h1 style="margin-bottom:4px;">Demat Shield – Admin</h1>
          <p class="small">
            Logged in as <span id="whoami"></span> • Tracking investor complaints filed via website.
          </p>
        </div>
        <span class="pill">Admin only</span>
      </div>

      <div class="small" id="summary-line" style="margin-bottom:8px;">
        Loading complaints…
      </div>

      <div style="overflow-x:auto;">
        <table>
          <thead>
            <tr>
              <th>Created</th>
              <th>Investor</th>
              <th>DP / Broker</th>
              <th>Issue</th>
              <th>Status</th>
            </tr>
          </thead>
          <tbody id="complaints-body">
            <!-- rows injected here -->
          </tbody>
        </table>
      </div>

      <button class="logout-btn" id="logout-btn">Logout</button>
    </div>
  </div>

  <script>
    // Supabase config
    const SUPABASE_URL = "https://ncdphbagmeefgnaljtha.supabase.co";
    const SUPABASE_ANON_KEY =
      "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im5jZHBoYmFnbWVlZmduYWxqdGhhIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjM4ODg5NzEsImV4cCI6MjA3OTQ2NDk3MX0.RABZe9jC3SIeAOYOZaeOXcdSIDQicavdiKNYWuhOldE";

    const supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY, {
      auth: { persistSession: true }
    });

    const loginCard   = document.getElementById("login-card");
    const dashWrap    = document.getElementById("dashboard-wrapper");
    const statusMsg   = document.getElementById("status-msg");
    const sendBtn     = document.getElementById("send-link-btn");
    const whoamiEl    = document.getElementById("whoami");
    const logoutBtn   = document.getElementById("logout-btn");
    const tbody       = document.getElementById("complaints-body");
    const summaryLine = document.getElementById("summary-line");

    function showStatus(msg, type = "ok") {
      statusMsg.textContent = msg;
      statusMsg.className = "status " + type;
    }

    // send magic link
    async function sendMagicLink() {
      sendBtn.disabled = true;
      showStatus("Sending login link…");

      const email = "dematshield@outlook.in";

      const { error } = await supabaseClient.auth.signInWithOtp({
        email,
        options: {
          emailRedirectTo: "https://dematshield.in/admin.html"
        }
      });

      if (error) {
        console.error(error);
        showStatus("Error: " + error.message, "err");
      } else {
        showStatus("Link sent. Check your Outlook inbox.", "ok");
      }

      sendBtn.disabled = false;
    }

    // handle magic link URL
    async function handleMagicLinkInUrl() {
      if (window.location.hash.includes("access_token")) {
        const hash = window.location.hash.substring(1);
        const params = new URLSearchParams(hash);
        const access_token  = params.get("access_token");
        const refresh_token = params.get("refresh_token");

        if (access_token && refresh_token) {
          const { error } = await supabaseClient.auth.setSession({
            access_token,
            refresh_token
          });
          if (error) console.error("setSession error:", error);
        }

        window.history.replaceState({}, "", "/admin.html");
      }
    }

    function formatDate(dtString) {
      if (!dtString) return "";
      const d = new Date(dtString);
      return d.toLocaleDateString("en-IN", { day:"2-digit", month:"short", year:"numeric" }) +
             " " +
             d.toLocaleTimeString("en-IN", { hour:"2-digit", minute:"2-digit" });
    }

    function renderComplaints(data) {
      tbody.innerHTML = "";
      if (!data || data.length === 0) {
        tbody.innerHTML =
          '<tr><td colspan="5" class="small">No complaints yet.</td></tr>';
        summaryLine.textContent = "0 complaints in system.";
        return;
      }

      summaryLine.textContent = `${data.length} complaint${data.length > 1 ? "s" : ""} loaded.`;

      for (const row of data) {
        const tr = document.createElement("tr");

        const createdTd = document.createElement("td");
        createdTd.textContent = formatDate(row.created_at);
        tr.appendChild(createdTd);

        const investorTd = document.createElement("td");
        investorTd.innerHTML =
          `<strong>${row.name || "-"}</strong><br>` +
          `<span class="small">${row.email || ""}${row.mobile ? " • " + row.mobile : ""}</span>`;
        tr.appendChild(investorTd);

        const dpTd = document.createElement("td");
        dpTd.textContent = row.dp || "-";
        tr.appendChild(dpTd);

        const issueTd = document.createElement("td");
        issueTd.textContent = row.issue || "";
        tr.appendChild(issueTd);

        const statusTd = document.createElement("td");
        const select = document.createElement("select");
        select.className = "status-select";
        const statuses = ["New", "In progress", "Resolved", "Closed"];
        const current = row.status || "New";

        statuses.forEach(s => {
          const opt = document.createElement("option");
          opt.value = opt.textContent = s;
          if (s === current) opt.selected = true;
          select.appendChild(opt);
        });

        select.addEventListener("change", async () => {
          const newStatus = select.value;
          const { error } = await supabaseClient
            .from("complaints")
            .update({ status: newStatus })
            .eq("id", row.id);

          if (error) {
            console.error(error);
            alert("Could not update status: " + error.message);
            select.value = current;
          }
        });

        statusTd.appendChild(select);
        tr.appendChild(statusTd);

        tbody.appendChild(tr);
      }
    }

    async function loadComplaints() {
      summaryLine.textContent = "Loading complaints…";
      const { data, error } = await supabaseClient
        .from("complaints")
        .select("*")
        .order("created_at", { ascending: false });

      if (error) {
        console.error(error);
        summaryLine.textContent = "Error loading complaints.";
        tbody.innerHTML =
          '<tr><td colspan="5" class="small">Error loading complaints.</td></tr>';
        return;
      }

      renderComplaints(data);
    }

    async function checkSessionAndRender() {
      await handleMagicLinkInUrl();

      const { data: { session } } = await supabaseClient.auth.getSession();

      if (session && session.user) {
        loginCard.style.display = "none";
        dashWrap.style.display = "block";
        whoamiEl.textContent = session.user.email || "admin";

        loadComplaints();
      } else {
        loginCard.style.display = "block";
        dashWrap.style.display = "none";
      }
    }

    async function logout() {
      await supabaseClient.auth.signOut();
      window.location.href = "/admin.html";
    }

    sendBtn.addEventListener("click", sendMagicLink);
    logoutBtn.addEventListener("click", logout);

    checkSessionAndRender();
  </script>
</body>
</html>
