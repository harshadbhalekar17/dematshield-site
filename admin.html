<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Demat Shield ‚Äì Admin</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link rel="stylesheet" href="styles.css" />
  <style>
    body {
      margin: 0;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      background: #050816;
      color: #f9fafb;
      display: flex;
      align-items: center;
      justify-content: center;
      min-height: 100vh;
    }
    .card {
      background: #111827;
      padding: 24px 28px;
      border-radius: 12px;
      box-shadow: 0 18px 40px rgba(0, 0, 0, 0.45);
      width: 100%;
      max-width: 420px;
    }
    h1 {
      font-size: 20px;
      margin: 0 0 4px;
    }
    p {
      margin: 0 0 18px;
      font-size: 14px;
      color: #9ca3af;
    }
    .input-label {
      font-size: 12px;
      margin-bottom: 4px;
      color: #9ca3af;
    }
    .input {
      width: 100%;
      border-radius: 8px;
      border: 1px solid #1f2937;
      background: #020617;
      color: #f9fafb;
      padding: 10px 12px;
      font-size: 14px;
      box-sizing: border-box;
    }
    .input[disabled] {
      opacity: 0.7;
    }
    .btn {
      width: 100%;
      margin-top: 14px;
      padding: 10px 12px;
      border-radius: 8px;
      border: none;
      font-size: 14px;
      cursor: pointer;
      background: #2563eb;
      color: #f9fafb;
    }
    .btn:disabled {
      opacity: 0.6;
      cursor: default;
    }
    .status {
      margin-top: 10px;
      font-size: 13px;
    }
    .status.ok { color: #4ade80; }
    .status.err { color: #f97373; }

    .dashboard {
      max-width: 960px;
    }
    .top-row {
      display: flex;
      justify-content: space-between;
      gap: 12px;
      align-items: center;
      margin-bottom: 14px;
    }
    .pill {
      font-size: 12px;
      padding: 4px 8px;
      border-radius: 999px;
      background: #1e293b;
      color: #e5e7eb;
    }
  </style>

  <!-- Supabase client -->
  <script src="https://unpkg.com/@supabase/supabase-js@2.48.0/dist/umd/supabase.js"></script>
</head>
<body>
  <!-- LOGIN CARD -->
  <div class="card" id="login-card">
    <h1>Admin Login</h1>
    <p>No password. We‚Äôll send a one-time login link to your admin email.</p>

    <div class="input-label">Admin email</div>
    <input
      id="admin-email"
      class="input"
      type="email"
      value="dematshield@outlook.in"
      disabled
    />

    <button class="btn" id="send-link-btn">Send login link</button>
    <div class="status" id="status-msg"></div>
  </div>

  <!-- SIMPLE DASHBOARD PLACEHOLDER -->
  <div class="card dashboard" id="dashboard-card" style="display:none;">
    <div class="top-row">
      <div>
        <h1>Demat Shield ‚Äì Admin</h1>
        <p>Internal dashboard (logged in as <span id="whoami"></span>)</p>
      </div>
      <span class="pill">Admin only</span>
    </div>

    <p style="margin-bottom: 8px;">Dashboard coming next ‚Äì table of complaints, status updates, etc.</p>
    <p style="font-size: 13px; color:#9ca3af;">
      For now this just proves login is working correctly and your Supabase session is valid.
    </p>

    <button class="btn" id="logout-btn" style="margin-top:16px;background:#ef4444;">
      Logout
    </button>
  </div>

  <script>
    // üîê Supabase config (from your screenshots)
    const SUPABASE_URL = "https://ncdphbagmeefgnaljtha.supabase.co";
    const SUPABASE_ANON_KEY =
      "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im5jZHBoYmFnbWVlZmduYWxqdGhhIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjM4ODg5NzEsImV4cCI6MjA3OTQ2NDk3MX0.RABZe9jC3SIeAOYOZaeOXcdSIDQicavdiKNYWuhOldE";

    const supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY, {
      auth: { persistSession: true }
    });

    const loginCard = document.getElementById("login-card");
    const dashCard  = document.getElementById("dashboard-card");
    const statusMsg = document.getElementById("status-msg");
    const sendBtn   = document.getElementById("send-link-btn");
    const whoami    = document.getElementById("whoami");
    const logoutBtn = document.getElementById("logout-btn");

    function showStatus(msg, type = "ok") {
      statusMsg.textContent = msg;
      statusMsg.className = "status " + type;
    }

    async function sendMagicLink() {
      sendBtn.disabled = true;
      showStatus("Sending login link‚Ä¶");

      const email = "dematshield@outlook.in";

      const { error } = await supabaseClient.auth.signInWithOtp({
        email,
        options: {
          emailRedirectTo: "https://dematshield.in/admin.html"
        }
      });

      if (error) {
        console.error(error);
        showStatus("Error: " + error.message, "err");
      } else {
        showStatus("Link sent. Check your Outlook inbox.", "ok");
      }

      sendBtn.disabled = false;
    }

    // When user comes back via magic link, URL will contain #access_token=...
    async function handleMagicLinkInUrl() {
      if (window.location.hash.includes("access_token")) {
        const hash = window.location.hash.substring(1);
        const params = new URLSearchParams(hash);
        const access_token = params.get("access_token");
        const refresh_token = params.get("refresh_token");

        if (access_token && refresh_token) {
          const { error } = await supabaseClient.auth.setSession({
            access_token,
            refresh_token
          });
          if (error) console.error("setSession error:", error);
        }

        // Clean URL so token is not visible
        window.history.replaceState({}, "", "/admin.html");
      }
    }

    async function checkSessionAndRender() {
      await handleMagicLinkInUrl();

      const { data: { session } } = await supabaseClient.auth.getSession();

      if (session && session.user) {
        // Logged in ‚Üí show dashboard
        loginCard.style.display = "none";
        dashCard.style.display = "block";
        whoami.textContent = session.user.email || "admin";
      } else {
        // Not logged in ‚Üí show login card
        loginCard.style.display = "block";
        dashCard.style.display = "none";
      }
    }

    async function logout() {
      await supabaseClient.auth.signOut();
      window.location.href = "/admin.html";
    }

    sendBtn.addEventListener("click", sendMagicLink);
    logoutBtn.addEventListener("click", logout);

    // Run on page load
    checkSessionAndRender();
  </script>
</body>
</html>
